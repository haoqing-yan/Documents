
## 什么是交易

渠道 -> ESB -> 核心 \ 支付系统 -> 仓库

全局流水号
交易流水号

- ESB

  转发
  组合

- 核心

  核心流水号
  序号
  存于批量中

- 缓存

## 日切

日期切换，更换系统记账的时间；对当天的系统业务进行集中处理，处理完毕后，系统从当前工作日切换到下一工作日，日切过程中交易可以照常提交并正确处理返回。

- 准点日切

 日前 ---> 日终批量 ---> 日初

![](./picture/日切.png)

结算采取两种方式进行日切：
1. 到点采取读取时间表的方式进行切换
2. 取同一个机器上的系统时间

分以下两种情况分别采取不同的上述两种结算方式:
1. 在 12 点前日前结算跑批结束，此时采取上述两种任意一种方式都可以
2. 日前在 12 点前计算没有跑批结束，则采取账目时间统计使用 T 日的结算方式

![](./picture/日切跑批1.png)

上述图片中，红色为日前跑批的时间，而粉红色为空挡时间，此时所有的联机交易都为 T 日， 而在 12 点后则计算为 T + 1, 批量交易要在日终跑批结束后才能计算为 T + 1

![](./picture/日切跑批2.png)

上述图片中 红色 + 粉红色为日前跑批的时间，粉红色为超出日前跑批超过　12 点的时间，此时联机交易在 12 点前取当前系统时间，而日前跑批交易则为也为 T 取的日期为日期表的日期

- 双余额机制

将余额分为当前余额和上次更新余额
```
分户处理：
按照交易的日期分为次日，前日处理
表字段增加以下

| 当前余额 | 上次更新日期 | 上日余额 | 发生交易时 |
| balance | last_date | last_balance | date |

交易日期 > 上次交易日期 ：
    1.当前余额 → 上次余额
    2.当前余额 +/- 交易金额 → 当前余额
    3.交易日期 → 上次交易日期
交易日期 = 上次交易日期 ：
    1.当前余额 +/- 交易金额 → 当前余额
交易日期 < 上次交易日期 ：
    1.当前余额 +/- 交易金额 → 当前余额
    2.上次余额 +/- 交易金额 → 上次余额

```
